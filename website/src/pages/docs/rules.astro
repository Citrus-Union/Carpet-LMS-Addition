---
import StarlightPage from "@astrojs/starlight/components/StarlightPage.astro";
import AnchorHeading from "@astrojs/starlight/components/AnchorHeading.astro";
import yaml from "js-yaml";

import rawYaml from "../../../../src/main/resources/assets/carpetlmsaddition/lang/en_us.yml?raw";

type RuleExtra = Record<string, unknown>;
type RuleEntry = {
  name?: string;
  desc?: string;
  extra?: RuleExtra;
};

type TranslationData = {
  carpet?: {
    rule?: Record<string, RuleEntry>;
  };
};

const data = yaml.load(rawYaml) as TranslationData;
const ruleMap: Record<string, RuleEntry> = data?.carpet?.rule ?? {};

const normalizeName = (key: string, rule: RuleEntry) => {
  return rule?.name && String(rule.name).trim().length > 0
    ? String(rule.name)
    : key;
};

const headings = Object.entries(ruleMap).map(([key, rule]) => ({
  depth: 2,
  slug: key,
  text: normalizeName(key, rule),
}));
---

<StarlightPage
  frontmatter={{
    title: "Rules",
    description: "Overview of the rules for Carpet LMS Addition",
  }}
  headings={headings}
>
  {
    Object.entries(ruleMap).map(([key, rule]) => {
      const name = normalizeName(key, rule);
      const desc = rule?.desc;
      const extra = rule?.extra ?? null;

      return (
        <section style={{ marginBottom: "2rem" }}>
          <AnchorHeading level={2} id={key}>
            {name}
          </AnchorHeading>

          {desc && <p>{String(desc)}</p>}

          {extra && (
            <ul>
              {Object.entries(extra).map(([, v]) => (
                <li>{String(v)}</li>
              ))}
            </ul>
          )}

          <hr />
        </section>
      );
    })
  }
</StarlightPage>
